<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Your Application Details</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, Arial, sans-serif; background: #f6f8fa; margin: 0; }
    .main-card { max-width: 600px; margin: 40px auto; padding: 32px; border-radius: 18px; background: #fff; box-shadow: 0 8px 24px rgba(15,23,42,0.10); border: 1px solid #e0e0e0; }
    h2 { margin-top: 0; font-size: 2rem; color: #1976d2; }
    .field { margin-bottom: 18px; font-size: 1.1rem; }
    .label { font-weight: 600; color: #1976d2; }
    .value { font-size: 17px; color: #222; }
    .status-badge { display: inline-block; padding: 6px 16px; border-radius: 16px; font-weight: 700; font-size: 1rem; margin-left: 8px; }
    .status-pending { background: #f0ad4e; color: #fff; }
    .status-approved { background: #388e3c; color: #fff; }
    .status-rejected { background: #d32f2f; color: #fff; }
    .dss-cards { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 28px; }
    .dss-card { background: linear-gradient(180deg,#fff,#f6f8fa); border-radius: 14px; padding: 18px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(15,23,42,0.07); width: calc(50% - 16px); min-width: 220px; }
    .dss-row { display: flex; align-items: center; gap: 10px; }
    .dss-icon { width: 44px; height: 44px; border-radius: 10px; background: #e8f5e9; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .dss-title { font-weight: 700; font-size: 1.1rem; color: #1976d2; }
    .dss-badge { margin-left: auto; background: #1976d2; color: #fff; padding: 5px 12px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; }
    .dss-reasons { color: #555; margin-top: 8px; font-size: 0.98rem; }
    .dss-desc { color: #333; margin-top: 10px; font-size: 0.98rem; }
    .dss-learn { display: inline-block; margin-top: 8px; color: #1976d2; font-weight: 700; text-decoration: none; }
    @media (max-width:760px){ .main-card{padding:16px;} .dss-card{width:100%;} .dss-cards{gap:10px;} }
    .profile-bar { position: absolute; top: 22px; right: 28px; display: flex; align-items: center; gap:10px; }
    .profile-icon { width: 44px; height: 44px; border-radius: 50%; background: #2b8c2b; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 6px; }
    .logout-btn { padding: 8px 16px; background: #d32f2f; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    #trackProgressBtn { margin-top: 24px; padding: 12px 22px; background: #1976d2; color: #fff; border: none; border-radius: 10px; font-weight: 700; font-size: 1.1rem; cursor: pointer; }
  </style>
</head>
<body>
  <div class="profile-bar" id="profileBar" style="display:none;">
    <div class="profile-icon" id="profileIcon" title="Profile"></div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>
  <div class="main-card">
    <h2>Your Application</h2>
    <div class="field"><span class="label">Name:</span> <span class="value" id="applicantName"></span></div>
    <div class="field"><span class="label">Tribal Note:</span> <span class="value" id="tribalNote"></span></div>
    <div class="field"><span class="label">Village:</span> <span class="value" id="villageName"></span></div>
    <div class="field"><span class="label">State:</span> <span class="value" id="stateKey"></span></div>
    <div class="field"><span class="label">Status:</span> <span class="value" id="appStatus"></span> <span id="statusBadge" class="status-badge status-pending"></span></div>
    <button id="trackProgressBtn">Track Progress</button>
    <div id="dssSchemesPanel" style="margin-top:32px;"></div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB8FWKokLgsgJ_uDDF1HSWh6brugLjK_9g",
      authDomain: "sih-fra.firebaseapp.com",
      projectId: "sih-fra",
      storageBucket: "sih-fra.appspot.com",
      messagingSenderId: "808806324009",
      appId: "1:808806324009:web:5fd76cefa57b89c28c8938"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  // ...existing code...
    const DSS_ICONS = {
      'PM-KISAN': 'ðŸŒ¾',
      'Jal Jeevan Mission': 'ðŸš°',
      'MGNREGA': 'ðŸ”¨',
      'DAJGUA': 'ðŸ›–'
    };
    const DSS_HELP = {
      'PM-KISAN': 'Income support for small and marginal farmers. Requires farming household and small landholding.',
      'Jal Jeevan Mission': 'Piped drinking water support for households lacking tap connections.',
      'MGNREGA': 'Employment guarantee for rural households, particularly labourers and low-income families.',
      'DAJGUA': 'Tribal-focused assistance and benefits for Scheduled Tribes or vulnerable tribal households.'
    };
    function renderStatusBadge(status) {
      const badge = document.getElementById('statusBadge');
      badge.textContent = status;
      badge.className = 'status-badge ' + (status === 'Approved' ? 'status-approved' : status === 'Rejected' ? 'status-rejected' : 'status-pending');
    }
    function renderDssSchemes(schemes) {
      const panel = document.getElementById('dssSchemesPanel');
      panel.innerHTML = '';
      if (!schemes || !schemes.length) return;
      const container = document.createElement('div'); container.className = 'dss-cards';
      schemes.forEach((r, idx) => {
        const name = r.scheme || r[0] || r || 'Unknown';
        const score = (r.score !== undefined) ? r.score : (r.raw_score !== undefined ? Math.round(r.raw_score) : undefined);
        const reasons = r.reasons || r.reason || [];
        const card = document.createElement('div'); card.className = 'dss-card';
        const row = document.createElement('div'); row.className = 'dss-row';
        const icon = document.createElement('div'); icon.className = 'dss-icon'; icon.textContent = DSS_ICONS[name] || 'âœ¨';
        row.appendChild(icon);
        const title = document.createElement('div'); title.className = 'dss-title'; title.textContent = name;
        row.appendChild(title);
        const badge = document.createElement('div'); badge.className = 'dss-badge'; badge.textContent = (score!==undefined?score:''); row.appendChild(badge);
        card.appendChild(row);
        if (reasons && reasons.length) { const rr = document.createElement('div'); rr.className = 'dss-reasons'; rr.textContent = reasons.join('; '); card.appendChild(rr); }
        const desc = r.description || r.desc || '';
        if (desc) { const d = document.createElement('div'); d.className = 'dss-desc'; d.textContent = desc; card.appendChild(d); }
        // Remove unwanted Learn more links
        container.appendChild(card);
      });
      panel.appendChild(container);
    }
    let lastApplicant = null;
    let lastUserId = null;
    auth.onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "/";
        return;
      }
      document.getElementById('profileBar').style.display = 'flex';
      document.getElementById('profileIcon').textContent = user.email ? user.email[0].toUpperCase() : 'U';
      document.getElementById('profileIcon').title = user.email;
      document.getElementById('logoutBtn').onclick = function() {
        auth.signOut().then(() => {
          window.location.href = "/";
        });
      };
      db.collection('applications')
        .where('userId', '==', user.uid)
        .limit(1)
        .get()
        .then(snapshot => {
          if (!snapshot.empty) {
            const app = snapshot.docs[0].data();
            document.getElementById('applicantName').textContent = app.applicant || '';
            document.getElementById('tribalNote').textContent = app.tribal_note || '';
            document.getElementById('villageName').textContent = app.village || '';
            document.getElementById('stateKey').textContent = app.stateKey || '';
            document.getElementById('appStatus').textContent = app.status || 'Pending';
            renderStatusBadge(app.status || 'Pending');
            lastApplicant = app.applicant || '';
            lastUserId = user.uid;
            // DSS schemes
            let schemes = app.dss_selected_schemes || [];
            if (!schemes.length && app.dss_recommendations_snapshot && app.dss_recommendations_snapshot.length) {
              schemes = app.dss_recommendations_snapshot;
            }
            renderDssSchemes(schemes);
          } else {
            document.querySelector('.main-card').innerHTML = '<h2>No Application Found</h2>';
          }
        });
    });

    document.getElementById('trackProgressBtn').onclick = function() {
      if (!lastUserId && !lastApplicant) return;
      fetch('/get_app_status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: lastUserId, applicant: lastApplicant })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.status) {
          document.getElementById('appStatus').textContent = data.status;
          renderStatusBadge(data.status);
        }
      });
    };
  </script>
</body>
</html>
